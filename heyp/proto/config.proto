// This file contains definitions of all configuration protos.
// These messages should only be stored in textual or in-memory form (i.e. not
// the binary format), so feed free to change any field numbers.

syntax = "proto2";

package heyp.proto;

option go_package = "github.com/uluyol/heyp-agents/go/proto";

import "heyp/proto/heyp.proto";

message DemandPredictorConfig {
  optional string time_window_dur = 1 [default = "10s"];
  optional double usage_multiplier = 2 [default = 1.1];
  optional int64 min_demand_bps = 3 [default = 5000000];
}

message HostFlowTrackerConfig {
  optional DemandPredictorConfig demand_predictor = 1;
  optional bool ignore_instantaneous_usage = 2 [default = true];
}

message FlowAggregatorConfig {
  optional DemandPredictorConfig demand_predictor = 1;
}

message HostFlowStateReporterConfig {
  repeated string this_host_addrs = 1;
  optional string ss_binary_name = 2 [default = "ss"];
}

message HostEnforcerConfig {
  optional string device = 1 [default = "eth0"];

  // If specified, will periodically dump iptables and tc state here.
  optional string debug_log_dir = 2;
}

message HostDaemonConfig {
  optional string collect_stats_period = 1 [default = "500ms"];
  optional string inform_period_dur = 2 [default = "2s"];
  optional string cluster_agent_addr = 3;
  optional string cluster_agent_connection_timeout_dur = 4 [default = "10s"];
}

message StaticDCMapperConfig {
  optional DCMapping mapping = 1;
}

message HostAgentConfig {
  optional HostFlowTrackerConfig flow_tracker = 1;
  optional FlowAggregatorConfig socket_to_host_aggregator = 2;
  optional HostFlowStateReporterConfig flow_state_reporter = 3;
  optional HostEnforcerConfig enforcer = 4;
  optional HostDaemonConfig daemon = 5;
  optional StaticDCMapperConfig dc_mapper = 6;
}

enum ClusterAllocatorType {
  BWE = 0;
  HEYP_SIGCOMM20 = 1;
}

message ClusterAllocatorConfig {
  optional ClusterAllocatorType type = 1 [default = BWE];
  optional bool enable_burstiness = 2 [default = true];
  optional bool enable_bonus = 3 [default = true];
  optional double oversub_factor = 4 [default = 1.15];
  optional double heyp_acceptable_measured_ratio_over_intended_ratio = 5
      [default = 0.9];
}

message ClusterServerConfig {
  optional string address = 1 [default = ":1415"];
  optional string control_period = 2 [default = "5s"];
}

message ClusterAgentConfig {
  optional FlowAggregatorConfig flow_aggregator = 1;
  optional ClusterAllocatorConfig allocator = 2;
  optional ClusterServerConfig server = 3;
}